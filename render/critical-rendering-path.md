# 渲染路径
呈现路径涉及以下步骤：

- 通过 HTML 构建文档对象模型 (DOM)。
- 通过 CSS 构建 CSS 对象模型 (CSSOM)。
- 应用任何会更改 DOM 或 CSSOM 的 JavaScript。
- 通过 DOM 和 CSSOM 构建渲染树。
- 在页面上执行样式和布局操作，看看哪些元素适合显示。
- 在内存中绘制元素的像素。
- 如果有任何像素重叠，则合成像素。
- 以物理方式将所有生成的像素绘制到屏幕上


# 关键渲染路径 (Critical Rendering Path)
浏览器在执行初始渲染之前执行的一系列步骤称为“关键渲染路径”，浏览器是渐进式渲染的。


## 渐进式渲染
闪烁：如果不等 CSS，JS 加载完毕就渲染 HTML，加载后续再次再次渲染就可能出现闪烁的情况,因为样式会影响布局。   
白屏：如果等 CSS，js 加载完毕在渲染 HTML，就会出现长时间的空白屏幕。   

浏览器需要知道它应该等待的最小资源数量，以避免呈现明显损坏的页面。另一方面，浏览器在向用户展示某些内容之前也不应等待超过必要的时间。


## 初始渲染
浏览器需要等待一些关键资源下载，然后才能完成初始渲染。这些资源包括：

- 部分 HTML
- `<head>` 元素中的渲染阻塞 CSS (不区分媒体属性的样式表)
- `<head> `元素中的渲染阻止 JavaScript (没有添加 async, defer 标识的 script)


## 解析阻塞资源
默认情况下，JavaScript 是解析器阻塞的（除非特别标记为异步或延迟），因为 JavaScript 可以在执行时更改 DOM 或 CSSOM。
因此，浏览器不可能继续处理其他资源，直到它知道请求的 JavaScript 对页面的 HTML 的全部影响。因此，同步 JavaScript 会阻止解析器。

出于这个原因，当解析器被阻止的时候，浏览器将尝试通过使用称为预加载扫描程序的辅助 HTML 解析器来下载即将到来的资源。

## 渲染阻塞资源（Render-blocking resources）
CSS 会阻塞渲染，但不会阻塞解析后续的 HTML。某些浏览器（最初是 Firefox，现在还有 Chrome）会渲染阻止资源前面的内容，
后面的内容则会阻止渲染直到阻止资源加载完毕。但是 `<head>`标签中的阻塞资源会阻止整个页面的渲染。


## 字体
```
在发现网络字体并确保当前页面布局需要这些字体后，浏览器可以下载这些字体

只有在所有阻止渲染的资源加载完毕后，浏览器才会开始下载字体文件。
这意味着，如果您已内嵌 @font-face 声明，但其余的 CSS 位于外部样式表中，浏览器仍然需要等待外部样式表下载完毕。

浏览器发现并下载某种网页字体后，就可以进行渲染了。默认情况下，在下载使用网页字体的任何文本之前，浏览器都会阻止其渲染
```
- [优化网页字体](https://web.dev/learn/performance/optimize-web-fonts?hl=zh-cn)


## 构建对象模型
DOM 生成流程
1. 字节：(bytes)请求响应的字节
2. 字符: (characters)根据文档指定的编码将字节转成
3. 令牌：(tokens)将字符串进行分词生成令牌
4. 节点：(nodes)根据令牌生成node节点对象
5. DOM: 根据 HTML 标记定义的不同标记之间的关系，确定 node 之间的关系

CSSOM 生成流程
1. 字节：(bytes)请求响应的字节
2. 字符: (characters)根据文档指定的编码将字节转成
3. 令牌：(tokens)将字符串进行分词生成令牌
4. 节点：(nodes)根据令牌生成node节点对象
5. CSSOM: document.styleSheets


## 渲染树构建、布局和绘制
- DOM 树和 CSSOM 树会组合成渲染树。
- 渲染树仅包含渲染网页所需的节点。
- 布局计算每个对象的精确位置和大小。
- 最后一步是绘制，它接受最终的渲染树并将像素渲染到屏幕上。


## 阻塞渲染的 CSS
- 默认情况下，CSS 被视为阻塞渲染的资源。
- 我们可以通过媒体类型和媒体查询将一些 CSS 资源标记为不阻塞渲染。
- 浏览器会下载所有 CSS 资源（无论阻塞行为还是非阻塞行为）。

备注：因为渲染树的构建需要 DOM 和 CSSOM。DOM 确定了文档的结构， CSSOM 确定了哪些 DOM 节点是可见的，并确认了节点的样式。
所以默认情况下，CSS 被视为阻塞渲染的资源。


## 使用 JavaScript 添加互动
- 脚本在文档中的位置非常重要。
- 当浏览器遇到脚本标记时(除非明确声明为异步)，DOM 构建将暂停，直到脚本执行完毕。
- JavaScript 可以查询和修改 DOM 和 CSSOM。
- 浏览器将延迟脚本执行和 DOM 构建，直到其完成 CSSOM 的下载和构建。


## 衡量关键渲染路径
- domLoading：这是整个过程的起始时间戳，浏览器将开始解析 HTML 文档的第一个收到的字节。
- domInteractive：DOM 已就绪。标记浏览器解析完所有 HTML 且 DOM 构建完成的时间点。
- domContentLoaded： DOM 和 CSSOM 均已准备就绪。表示 DOM 准备就绪且没有样式表阻止 JavaScript 执行的时间点。
  也就是说，我们现在可以（有可能）构建渲染树。许多 JavaScript 框架都会等待此事件，然后才会开始执行自己的逻辑。
- domComplete：顾名思义，所有处理已完成，网页上的所有资源（图片等）都已下载完毕，也就是说，加载旋转图标已停止旋转。
- loadEvent：作为每个网页加载的最后一步，浏览器会触发 onload 事件，该事件可以触发其他应用逻辑。


## 分析关键渲染路径性能
描述关键渲染路径的词汇：
- 关键资源：可能阻止网页首次呈现的资源。
- 关键路径长度：获取所有关键资源所需的往返次数或总时间。从接收到第一个关键资源的第一个字节到最后一个关键资源的最后一个字节所花的时间。
- 关键字节数：首次渲染网页所需的总字节数，即所有关键资源的传输文件大小的总和。


## 优化关键渲染路径
为了尽可能快地完成首次渲染，我们需要最大限度地减少以下三个变量：
- 关键资源的数量。
- 关键路径长度。
- 关键字节数。

优化关键渲染路径的一般步骤如下：
- 分析关键路径并总结其特点：资源数量、字节数、长度。
- 最大限度地减少关键资源的数量：删除、延迟下载、标记为异步等。
- 优化关键字节数以缩短下载时间（往返次数）。
- 优化其余关键资源的加载顺序：尽早下载所有关键资源，以缩短关键路径长度。

备注: TCP 传输有慢启动性质，


## 参考资料
[谷歌开发者文档](https://web.dev/articles/critical-rendering-path?hl=zh-cn)
[关键渲染路径](https://web.dev/learn/performance/understanding-the-critical-path?hl=zh-cn)